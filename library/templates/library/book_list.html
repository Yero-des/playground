{% extends 'base.html' %}
{% load static %}

{% block page_icon %}
  <link rel="shortcut icon" href="{% static "icons/book.ico" %}" type="image/x-icon">
{% endblock page_icon %}

{% block title %}
  Library
{% endblock %}

{% block page_style %}
  <link rel="stylesheet" href="{% static 'library/css/library_styles.css' %}" />
{% endblock %}

{% block content %}

  {% include "includes/page_img.html" %}

  <div class="container mb-5 p-0">
    <h1 class="title text-primary">Library</h1>

    <h2 class="text-secondary">Seguir leyendo</h2>

    <div class="row row-cols-lg-5 row-cols-md-3 row-cols-1 g-3">

      {% for book in last_3_viewed_books %}

        <div class="col">
          <div class="card shadow overflow-hidden rounded-3">
            <header class="overflow-hidden bg-gray position-relative" style="height: 15rem;">
              {% if forloop.first %}
                <div class="position-absolute top-0 start-0 bg-danger text-light fw-bold px-5 rounded-3 rounded-top-0 rounded-start-0">Recien leido</div>
                <img
                  src="{% if book.detail and book.detail.cover_url != '' %}{{ book.detail.cover_url }}{% else %}{% static "library/img/cover-not-found.jpg" %}{% endif %}"
                  class="card-img-top object-fit-cover h-100" alt=''>
              {% else %}
                <img
                  src="{% if book.detail and book.detail.cover_url != '' %}{{ book.detail.cover_url }}{% else %}{% static "library/img/cover-not-found.jpg" %}{% endif %}"
                  class="card-img-top object-fit-cover h-100" alt='Imagen referencial del libro: "{{ book.title }}"'>
              {% endif %}
            </header>
            <div class="card-body">
              <h5 class="card-title text-truncate text-primary" title="{{ book.title }}">{{ book.title }}</h5>
              <h6 class="card-subtitle text-secondary" title="{{ book.author.name }}">{{ book.author.name }}</h6>
              <p class="card-text mb-2 phrase-truncate-4" title="{{ book.summary }}">{{ book.summary }}</p>
              <p class="card-text mb-2"><span class="text-secondary">Publication Date:</span> {{ book.publication_date|date:"d/m/Y" }}</p>
              <p class="card-text mb-2"><span class="text-secondary">Pages:</span> {{ book.pages }}</p>
              <div class="row mt-3 justify-content-center">
                <div class="col-auto">
                  <a href="{% url 'book_detail' pk=book.id %}" class="btn btn-primary">Ver Libro</a>
                </div>
                <div class="col-auto">
                  <a href="{% url 'add_review' pk=book.id %}" class="btn btn-secondary text-light">+ Reseña</a>
                </div>
              </div>
            </div>
          </div>
        </div>

      {% empty %}

        <p>Tu sesión aun no tiene libros vistos</p>
      
      {% endfor %}

    </div>

    <h2 class="text-secondary mt-2">Libreria</h2>

    <div class="row mb-3 justify-content-between align-items-end">

      {% comment %} Busqueda de libros {% endcomment %}
      <div class="col-6">
        <form method="get">
          <label for="searchForTitleAuthor" class="form-label text-secondary">Buscar por titulo o author</label>
          <div class="input-group">
            <input type="date" name="start" class="form-control" value="{{request.GET.start}}">
            <input type="date" name="end" class="form-control" value="{{request.GET.end}}">
            <input type="text" name="query_search" class="form-control" id="searchForTitleAuthor" aria-describedby="searchForValue" value="{% if query_search %}{{ query_search }}{% endif %}">
            <button type="submit" class="btn btn-primary">Enviar</button>
          </div>
        </form>
      </div>

      {% comment %} Paginacion para libros {% endcomment %}
      <div class="col-auto">
        <nav aria-label="...">
          <ul class="pagination m-0">

            {% if page_obj.has_previous %}

              <li class="page-item"><a class="page-link" href="?page=1&{{ query_string }}">Inicio</a></li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ query_string }}" aria-label="Previous">
                  <span aria-hidden="false">&laquo;</span>
                </a>
              </li>
              <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ query_string }}">{{ page_obj.previous_page_number }}</a></li>

            {% endif %}

            <li class="page-item active"><a class="page-link" href="?page={{ page_obj.number }}&{{ query_string }}">{{ page_obj.number }}</a></li>

            {% if page_obj.has_next %}

              <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ query_string }}">{{ page_obj.next_page_number }}</a></li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ query_string }}" aria-label="Next">
                  <span aria-hidden="false">&raquo;</span>
                </a>
              </li>
              <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&{{ query_string }}">Final</a></li>

            {% endif %}

          </ul>
        </nav>
      </div>

    </div>

    {% comment %} Ver todos los libros {% endcomment %}
    <div class="row row-cols-lg-5 row-cols-md-3 row-cols-1 g-3">

      {% for book in books %}

        <div class="col">
          <div class="card shadow overflow-hidden rounded-3">
            <header class="overflow-hidden bg-gray" style="height: 15rem;">
              <img
                src="{% if book.detail and book.detail.cover_url != '' %}{{ book.detail.cover_url }}{% else %}{% static "library/img/cover-not-found.jpg" %}{% endif %}"
                class="card-img-top object-fit-cover h-100" alt='Imagen referencial del libro: "{{ book.title }}"'>
            </header>
            <div class="card-body">
              <h5 class="card-title text-truncate text-primary" title="{{ book.title }}">{{ book.title }}</h5>
              <h6 class="card-subtitle text-secondary" title="{{ book.author.name }}">{{ book.author.name }}</h6>
              <p class="card-text mb-2 phrase-truncate-4" title="{{ book.summary }}">{{ book.summary }}</p>
              <p class="card-text mb-2"><span class="text-secondary">Publication Date:</span> {{ book.publication_date|date:"d/m/Y" }}</p>
              <p class="card-text mb-2"><span class="text-secondary">Pages:</span> {{ book.pages }}</p>
              <div class="row mt-3 justify-content-center">
                <div class="col-auto">
                  <a href="{% url 'book_detail' pk=book.id %}" class="btn btn-primary">Ver Libro</a>
                </div>
                <div class="col-auto">
                  <a href="{% url 'add_review' pk=book.id %}" class="btn btn-secondary text-light">+ Reseña</a>
                </div>
              </div>
            </div>
          </div>
        </div>

      {% empty %}

        <div class="col">
          <p>No se encontraron libros</p>
        </div>

      {% endfor %}

    </div>

  </div>

{% endblock %}
